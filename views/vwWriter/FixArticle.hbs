{{#section "css"}}
    <link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.0/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-icons/1.11.3/font/bootstrap-icons.min.css" integrity="sha512-dPXYcDub/aeb08c63jRq/k6GaKccl256JQy/AnOq7CAnEZ9FzSL9wSbcZkMp4R26vBsMLFYH4kQ67/bbV8XaCQ==" crossorigin="anonymous" referrerpolicy="no-referrer" />
{{/section}}

{{#section 'js'}}
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.0/js/fileinput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/5.5.0/js/locales/vi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/5.5.0/themes/fa4/theme.min.js"></script>
    <script src="https://cdn.tiny.cloud/1/0su44cyz9o7c5h25fgma5227lueuup5jenu9qrhfmid4kdqh/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>

    <script>
        // Initialize TinyMCE
        tinymce.init({
            selector: '#content',
            plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | removeformat',
            height: 300,
            menubar: false,
            statusbar: false,
            setup: function (editor) {
                editor.on('change', function () {
                    editor.save();
                });
            }
        });
        // Preview functionality
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("#edit-article-form");

            form.addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent the default form submission

                // Get all the tags
                const tags = getAllTags();

                // Create a hidden input to store the tags
                const tagsInput = document.createElement("input");
                tagsInput.type = "hidden";
                tagsInput.name = "tags";
                tagsInput.value = JSON.stringify(tags);

                // Append the hidden input to the form
                form.appendChild(tagsInput);

                // Print the form data to the console
                const formData = new FormData(form);
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ": " + pair[1]);
                }

                // Submit the form programmatically
                form.submit();
            });

            const previewButton = document.getElementById("preview");

            previewButton.addEventListener("click", () => {
                const title = document.getElementById("title").value;
                const abstract = document.getElementById("abstract").value;
                const content = tinymce.get("content").getContent();
                const category = document.getElementById("category").selectedOptions[0].text;
                const tags = getAllTags();
                const publishDate = new Date().toLocaleDateString();
                const authorName = `{{user.username}}`;
                console.log("Preview button clicked");

                // Get the image uploaded path
                const thumbnailFile = document.getElementById("thumbnail").files[0];
                let thumbnailURL = "";  // Default empty URL

                if (thumbnailFile) {
                    // Generate temporary object URL for the selected file
                    thumbnailURL = URL.createObjectURL(thumbnailFile);
                }
                else {
                    thumbnailURL = "/public/posts/imgs/{{article.id}}/thumbnail.jpg";
                }

                const views = 0;  // Placeholder for views count
                const likes = 0;  // Placeholder for likes count

                const previewWindow = window.open("", "previewWindow");
                previewWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Hubot+Sans:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
                <style>
                    * {
                        font-family: "Hubot Sans", sans-serif;
                        font-optical-sizing: auto;
                        font-variation-settings: "wdth" 100;
                    }
                </style>
                <title>Preview</title>
            </head>
            <body>
                <div class="container-xl my-5">
                    <article class="mb-5">
                        <!-- Title -->
                        <h1 class="h1 text-center font-weight-bold mb-4">${title}</h1>

                        <!-- Abstract Box -->
                        <div class="p-4 bg-light border rounded shadow-sm mb-4">
                            <p class="mb-0">${abstract}</p>
                        </div>

                        <!-- Main Image -->
                        <div class="text-center mb-4">
                            <img src="${thumbnailURL}" class="img-fluid rounded shadow" alt="Main Image">
                        </div>

                        <!-- Main Content -->
                        <div class="container-fluid mb-4">
                            ${content}
                        </div>

                        <!-- Category -->
                        <div class="container-fluid mb-4">
                            <div class="row mb-2">
                                <div class="col-12">
                                    <p>
                                        <i class="fas fa-folder"></i> Thể loại:
                                        <a href="#" class="text-primary text-decoration-none">${category}</a>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata -->
                        <div class="container text-muted mb-4">
                            <div class="row">
                                <!-- Left Section -->
                                <div class="col-md-6">
                                    <!-- Views -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                                                </svg>
                                                &nbsp;Đã xem: ${views}
                                            </p>
                                        </div>
                                    </div>
                                    <!-- Likes -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                                                </svg>
                                                &nbsp;Đã thích: ${likes}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Section -->
                                <div class="col-md-6 text-right">
                                    <!-- Author -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                                                </svg>
                                                &nbsp;Đăng bởi: <strong>${authorName}</strong>
                                            </p>
                                        </div>
                                    </div>
                                    <!-- Publish Date -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-check" viewBox="0 0 16 16">
                                                    <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                                                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                                                </svg>
                                                &nbsp;Đăng vào: ${publishDate}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </body>
            </html>
        `);
                previewWindow.document.close();
            });
        });
    </script>

    <script>
        const imagePath = "/public/posts/imgs/{{article.id}}/thumbnail.jpg";
        $("#thumbnail").fileinput({
            dropZoneEnabled: false,
            showUpload: false,
            showCaption: true,
            fileActionSettings: {
                showZoom: false,
                showDrag: true,
            },
            overwriteInitial: false,
            maxFileCount: 1,
            allowedFileExtensions: ["jpg"],
            maxFileSize: 2000,
            theme: "fa4",
            language: "vi",
            initialPreview: [
                `<img src="${imagePath}" class="file-preview-image">`
            ],
            initialPreviewConfig: [
                {caption: "thumbnail.jpg", width: "1000px", width: "100%", // Make the image take up the full width of the container
                    height: "auto", key: 1}
            ]
        });
    </script>
{{/section}}
<!-- Sidebar -->
<div class="sidebar-overlay" id="sidebar">
    <button class="sidebar-toggle-btn" id="toggle-sidebar" aria-label="Toggle Sidebar">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-arrow-right" viewBox="0 0 16 16">
            <path fill-rule="evenodd" d="M1 8a.5.5 0 0 1 .5-.5h11.793l-3.147-3.146a.5.5 0 0 1 .708-.708l4 4a.5.5 0 0 1 0 .708l-4 4a.5.5 0 0 1-.708-.708L13.293 8.5H1.5A.5.5 0 0 1 1 8" />
        </svg>
    </button>
    <nav class="nav flex-column p-4">
        <a class="nav-link text-white glow-on-hover" href="./post-article">Viết bài mới&nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-pen-fill" viewBox="0 0 16 16">
                <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001"/>
            </svg>
        </a>
        <a class="nav-link text-white glow-on-hover" href="./my-articles">Bài viết của tôi&nbsp;
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-earmark-text-fill" viewBox="0 0 16 16">
                <path d="M9.293 0H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V4.707A1 1 0 0 0 13.707 4L10 .293A1 1 0 0 0 9.293 0M9.5 3.5v-2l3 3h-2a1 1 0 0 1-1-1M4.5 9a.5.5 0 0 1 0-1h7a.5.5 0 0 1 0 1zM4 10.5a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7a.5.5 0 0 1-.5-.5m.5 2.5a.5.5 0 0 1 0-1h4a.5.5 0 0 1 0 1z"/>
            </svg>
        </a>
    </nav>
</div>

<main class="container my-4">
    <form action="/writer/fix-article/submit?id={{article.id}}" method="POST" enctype="multipart/form-data" id="edit-article-form">
    <div class="form-group">
        <label for="title">Tiêu đề bài viết</label>
        <input type="text" class="form-control" id="title" name="title" value="{{article.title}}" required />
    </div>

    <div class="form-group">
        <label for="thumbnail">Ảnh nền</label>
        <input type="file" class="file form-control-file" id="thumbnail" name="thumbnail" required value=""/>
    </div>

    <div class="form-group">
        <label for="abstract">Tóm tắt</label>
        <textarea class="form-control" id="abstract" name="abstract" required>{{article.abstract}}</textarea>
    </div>

    <div class="form-group">
        <label for="content">Nội dung</label>
        <textarea class="form-control" id="content" name="content" required>{{{article.content}}}</textarea>
    </div>

    <div class="form-group">
        <label for="category">Chuyên mục</label>
        <select class="form-control" id="category" name="category" required>
            <option value="" disabled>Chọn chuyên mục</option>
            {{#each categories}}
                <optgroup label="{{this.name}}">
                    {{#if (length this.children)}}
                        {{#each this.children}}
                            {{#if (ifCond ../../article.categoryId "===" this.id)}}
                                <option value="{{this.id}}" selected>{{this.name}}</option>
                            {{else}}
                                <option value="{{this.id}}">{{this.name}}</option>
                            {{/if}}
                        {{/each}}
                    {{/if}}
                </optgroup>
            {{/each}}
        </select>
    </div>

    <div class="form-group">
        <label for="tags">Tags</label>
        <div class="input-group">
            <input type="text" class="form-control" id="tag-input" name="tags" value="{{article.tags}}" />
            <div class="input-group-append">
                <button class="btn btn-info" type="button" id="add-tag-btn">Thêm</button>
            </div>
        </div>
        <div class="tag-container" id="tag-container">
            <!-- Tags will appear here -->
        </div>
    </div>

    <div class="d-flex justify-content-center">
        <div class="btn-group" role="group" aria-label="Basic example">
            <button type="submit" class="btn btn-primary">Lưu</button>
            <a href="/writer" class="btn btn-secondary">Hủy</a>
            <button type="button" class="btn btn-success" id="preview">Xem trước</button>
        </div>
    </div>
    </form>
</main>

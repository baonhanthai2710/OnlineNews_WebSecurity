{{#section "css"}}
    <style>
        .tag-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 0.3rem 0.8rem;
        }

        .tag .remove-tag {
            display: flex;
            margin-left: 0.5rem;
            color: #dc3545;
        }

        .tag .remove-tag:hover {
            color: #a71d2a;
            cursor: pointer;
        }
    </style>
    <link href="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.0/css/fileinput.min.css" media="all" rel="stylesheet" type="text/css" />
{{/section}}

{{#section 'js'}}
    <script src="https://cdn.tiny.cloud/1/0su44cyz9o7c5h25fgma5227lueuup5jenu9qrhfmid4kdqh/tinymce/7/tinymce.min.js" referrerpolicy="origin"></script>
    <script>
        // Initialize TinyMCE
        tinymce.init({
            selector: '#content',
            plugins: 'advlist autolink lists link image charmap print preview hr anchor pagebreak',
            toolbar: 'undo redo | formatselect | bold italic | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link image | removeformat',
            height: 300,
            menubar: false,
            statusbar: false,
            setup: function (editor) {
                editor.on('change', function () {
                    editor.save();
                });
            }
        });
        // Add tag functionality
        document.addEventListener("DOMContentLoaded", () => {
            const tagInput = document.getElementById("tag-input");
            const addTagButton = document.getElementById("add-tag-btn");
            const tagContainer = document.getElementById("tag-container");

            function createTagElement(tagText) {
                const tag = document.createElement("div");
                tag.classList.add("tag");

                const tagContent = document.createElement("span");
                tagContent.textContent = tagText;
                tag.appendChild(tagContent);

                const removeButton = document.createElement("span");
                removeButton.classList.add("remove-tag");
                removeButton.innerHTML = "<svg xmlns=\"http://www.w3.org/2000/svg\" width=\"16\" height=\"16\" fill=\"currentColor\" class=\"bi bi-x-lg\" viewBox=\"0 0 16 16\">\n" +
                        "  <path d=\"M2.146 2.854a.5.5 0 1 1 .708-.708L8 7.293l5.146-5.147a.5.5 0 0 1 .708.708L8.707 8l5.147 5.146a.5.5 0 0 1-.708.708L8 8.707l-5.146 5.147a.5.5 0 0 1-.708-.708L7.293 8z\"/>\n" +
                        "</svg>";
                removeButton.addEventListener("click", () => {
                    tagContainer.removeChild(tag);
                });

                tag.appendChild(removeButton);

                return tag;
            }

            function addTag() {
                const tagText = tagInput.value.trim();
                if (tagText) {
                    const tagElement = createTagElement(tagText);
                    tagContainer.appendChild(tagElement);
                    tagInput.value = "";
                    tagInput.focus();
                }
            }

            addTagButton.addEventListener("click", addTag);

            tagInput.addEventListener("keypress", (event) => {
                if (event.key === "Enter") {
                    addTag();
                    event.preventDefault();
                }
            });
        });
        // Preview functionality
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.querySelector("#post-article-form");

            form.addEventListener("submit", (event) => {
                event.preventDefault(); // Prevent the default form submission

                // Get all the tags
                const tags = getAllTags();

                // Create a hidden input to store the tags
                const tagsInput = document.createElement("input");
                tagsInput.type = "hidden";
                tagsInput.name = "tags";
                tagsInput.value = JSON.stringify(tags);

                // Append the hidden input to the form
                form.appendChild(tagsInput);

                // Print the form data to the console
                const formData = new FormData(form);
                for (let pair of formData.entries()) {
                    console.log(pair[0] + ": " + pair[1]);
                }

                // Submit the form programmatically
                form.submit();
            });

            function getAllTags() {
                const tags = [];
                const tagContainer = document.getElementById("tag-container");
                const tagElements = tagContainer.getElementsByClassName("tag");
                for (let tagElement of tagElements) {
                    const tagText = tagElement.querySelector("span").textContent;
                    tags.push(tagText);
                }
                return tags;
            }

            const previewButton = document.getElementById("preview");

            previewButton.addEventListener("click", () => {
                const title = document.getElementById("title").value;
                const summary = document.getElementById("summary").value;
                const content = tinymce.get("content").getContent();
                const category = document.getElementById("category").selectedOptions[0].text;
                const tags = getAllTags();
                const publishDate = new Date().toLocaleDateString();  // Use the current date as the publish date (this can be adjusted as needed)
                const authorName = document.getElementById("author-name").value;

                // Get the image uploaded path
                const thumbnailFile = document.getElementById("thumbnail").files[0];
                let thumbnailURL = "";  // Default empty URL

                if (thumbnailFile) {
                    // Generate temporary object URL for the selected file
                    thumbnailURL = URL.createObjectURL(thumbnailFile);
                }

                const views = 0;  // Placeholder for views count
                const likes = 0;  // Placeholder for likes count

                const previewWindow = window.open("", "previewWindow");
                previewWindow.document.write(`
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Hubot+Sans:ital,wght@0,200..900;1,200..900&display=swap" rel="stylesheet">
                <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css" integrity="sha384-xOolHFLEh07PJGoPkLv1IbcEPTNtaed2xpHsD9ESMhqIYd0nLMwNLD69Npy4HI+N" crossorigin="anonymous">
                <style>
                    * {
                        font-family: "Hubot Sans", sans-serif;
                        font-optical-sizing: auto;
                        font-variation-settings: "wdth" 100;
                    }
                </style>
                <title>Preview</title>
            </head>
            <body>
                <div class="container-xl my-5">
                    <article class="mb-5">
                        <!-- Title -->
                        <h1 class="h1 text-center font-weight-bold mb-4">${title}</h1>

                        <!-- Abstract Box -->
                        <div class="p-4 bg-light border rounded shadow-sm mb-4">
                            <p class="mb-0">${summary}</p>
                        </div>

                        <!-- Main Image -->
                        <div class="text-center mb-4">
                            <img src="${thumbnailURL}" class="img-fluid rounded shadow" alt="Main Image">
                        </div>

                        <!-- Main Content -->
                        <div class="container-fluid mb-4">
                            ${content}
                        </div>

                        <!-- Category -->
                        <div class="container-fluid mb-4">
                            <div class="row mb-2">
                                <div class="col-12">
                                    <p>
                                        <i class="fas fa-folder"></i> Thể loại:
                                        <a href="#" class="text-primary text-decoration-none">${category}</a>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Metadata -->
                        <div class="container text-muted mb-4">
                            <div class="row">
                                <!-- Left Section -->
                                <div class="col-md-6">
                                    <!-- Views -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-eye" viewBox="0 0 16 16">
                                                    <path d="M16 8s-3-5.5-8-5.5S0 8 0 8s3 5.5 8 5.5S16 8 16 8M1.173 8a13 13 0 0 1 1.66-2.043C4.12 4.668 5.88 3.5 8 3.5s3.879 1.168 5.168 2.457A13 13 0 0 1 14.828 8q-.086.13-.195.288c-.335.48-.83 1.12-1.465 1.755C11.879 11.332 10.119 12.5 8 12.5s-3.879-1.168-5.168-2.457A13 13 0 0 1 1.172 8z"/>
                                                    <path d="M8 5.5a2.5 2.5 0 1 0 0 5 2.5 2.5 0 0 0 0-5M4.5 8a3.5 3.5 0 1 1 7 0 3.5 3.5 0 0 1-7 0"/>
                                                </svg>
                                                &nbsp;Đã xem: ${views}
                                            </p>
                                        </div>
                                    </div>
                                    <!-- Likes -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-heart-fill" viewBox="0 0 16 16">
                                                    <path fill-rule="evenodd" d="M8 1.314C12.438-3.248 23.534 4.735 8 15-7.534 4.736 3.562-3.248 8 1.314"/>
                                                </svg>
                                                &nbsp;Đã thích: ${likes}
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right Section -->
                                <div class="col-md-6 text-right">
                                    <!-- Author -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-person-circle" viewBox="0 0 16 16">
                                                    <path d="M11 6a3 3 0 1 1-6 0 3 3 0 0 1 6 0"/>
                                                    <path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8m8-7a7 7 0 0 0-5.468 11.37C3.242 11.226 4.805 10 8 10s4.757 1.225 5.468 2.37A7 7 0 0 0 8 1"/>
                                                </svg>
                                                &nbsp;Đăng bởi: <strong>${authorName}</strong>
                                            </p>
                                        </div>
                                    </div>
                                    <!-- Publish Date -->
                                    <div class="row mb-2">
                                        <div class="col-12">
                                            <p>
                                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-calendar-check" viewBox="0 0 16 16">
                                                    <path d="M10.854 7.146a.5.5 0 0 1 0 .708l-3 3a.5.5 0 0 1-.708 0l-1.5-1.5a.5.5 0 1 1 .708-.708L7.5 9.793l2.646-2.647a.5.5 0 0 1 .708 0"/>
                                                    <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5M1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4z"/>
                                                </svg>
                                                &nbsp;Đăng vào: ${publishDate}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </article>
                </div>
            </body>
            </html>
        `);
                previewWindow.document.close();
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/gh/kartik-v/bootstrap-fileinput@5.5.0/js/fileinput.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/5.5.0/js/locales/vi.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-fileinput/5.5.0/themes/fa4/theme.min.js"></script>
    <script>
        $("#thumbnail").fileinput({
            dropZoneEnabled: false,
            maxFileCount: 1,
            allowedFileExtensions: ["jpg"],
            theme: "fa4",
            language: "vi",
        });
    </script>
{{/section}}
<main class="container my-4">
    <form action="/writer/submit-article" method="POST" enctype="multipart/form-data" id="post-article-form">
        <div class="form-group">
            <input type="hidden" class="form-control" id="author-name" name="author-name" value="{{user.username}}" readonly />
        </div>
        <div class="form-group">
            <label for="title">Tiêu đề bài viết</label>
            <input type="text" class="form-control" id="title" name="title" required />
        </div>

        <div class="form-group">
            <label for="thumbnail">Ảnh nền</label>
            <input type="file" class="form-control-file" id="thumbnail" name="thumbnail" required multiple/>
        </div>

        <div class="form-group">
            <label for="summary">Tóm tắt</label>
            <textarea class="form-control" id="summary" name="summary" required></textarea>
        </div>

        <div class="form-group">
            <label for="content">Nội dung</label>
            <textarea class="form-control" id="content" name="content" required></textarea>
        </div>

        <div class="form-group">
            <label for="category">Chuyên mục</label>
            <select class="form-control" id="category" name="category" required>
                <option value="" selected disabled>Chọn chuyên mục</option>
                {{#each categories}}
                    <option value="{{id}}">{{name}}</option>
                {{/each}}
            </select>
        </div>

        <div class="form-group">
            <label for="tag-input">Tags</label>
            <div class="input-group">
                <input type="text" id="tag-input" class="form-control" placeholder="Nhập với một tag" aria-label="Nhập với một tag" aria-describedby="add-tag-btn"/>
                <div class="input-group-append">
                    <button id="add-tag-btn" class="btn btn-primary" type="button">Thêm tag</button>
                </div>
            </div>
        </div>
        <div class="form-group">
            <div id="tag-container" class="tag-container border rounded p-3"></div>
        </div>

        <div class="d-flex justify-content-center">
            <div class="btn-group" role="group" aria-label="Basic example">
                <button type="button" class="btn btn-primary" id="preview">Xem trước</button>
                <button type="submit" class="btn btn-success">Đăng chờ duyệt</button>
            </div>
        </div>
    </form>
</main>